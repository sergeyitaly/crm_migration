<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Migration</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>Facillio.de accounts -> CRM contacts</h1>

        <!-- Authentication Form -->
        <div id="authForm">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="Enter your password" required>
            </div>
            <button id="authenticateBtn" class="btn">
                <i class="fas fa-check"></i> Authenticate
            </button>
        </div>

        <!-- Migration Button -->
        <button id="migrateBtn" class="btn" style="display: none;">
            <i class="fas fa-sync-alt"></i> Start Migration
        </button>

        <!-- Progress Bars -->
        <div class="progress-container" style="display: none;">
            <h3>Migration Progress</h3>

            <!-- Fetching Users Progress -->
            <div class="progress-bar">
                <div id="fetchingProgress" class="progress"></div>
            </div>
            <p id="fetchingMessage">Fetching Users: Not Started</p>

            <!-- Migration Progress -->
            <div class="progress-bar">
                <div id="migrationProgress" class="progress"></div>
            </div>
            <p id="migrationMessage">Migration: Not Started</p>
        </div>

        <!-- Status Cards -->
        <div class="status-cards" style="display: none;">
            <div class="card" id="fetchingStatus">
                <h3><i class="fas fa-download"></i> Fetching Status</h3>
                <p id="fetchingStatusMessage">Pending</p>
            </div>
            <div class="card" id="migrationStatus">
                <h3><i class="fas fa-database"></i> Migration Status</h3>
                <p id="migrationStatusMessage">Pending</p>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="logs" style="display: none;">
            <h3><i class="fas fa-clipboard-list"></i> Logs</h3>
            <button id="toggleLogs" class="btn">Show Logs</button>
            <div id="logsContainer" style="display: none;"></div>
        </div>
        <!-- Migration Summary Table -->
        <div class="migration-summary" style="display: none;">
            <h3><i class="fas fa-table"></i> Migration Summary</h3>
            <table id="migrationSummaryTable">
                <thead>
                    <tr>
                        <th>Entity</th>
                        <th>Source Records</th>
                        <th>Processed Records</th>
                        <th>Created</th>
                        <th>Updated</th>
                        <th>Errors</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated dynamically -->
                </tbody>
            </table>
        </div>
        <br/>
        <p class="excel-download" id="excelDownload" style="display: none;">
            <i class="fas fa-file-excel"></i> 
            <a id="excelLink" href="#" download>Download Excel Export</a>
        </p>
        
        <!-- CRM Link -->
        <div id="crmLinkContainer" style="display: none;">
            <a id="crmLink" href="#">Go to CRM Contacts</a>
        </div>
    </div>

    <script>
        let accessToken = null;

        document.getElementById("toggleLogs").addEventListener("click", function() {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.style.display = logsContainer.style.display === "none" ? "block" : "none";
            this.textContent = logsContainer.style.display === "none" ? "Show Logs" : "Hide Logs";
        });

        document.getElementById("authenticateBtn").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            if (!email || !password) {
                alert("Please enter both email and password.");
                return;
            }

            try {
                const response = await fetch("/authenticate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ email, password }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Authentication failed.");
                }

                const data = await response.json();
                accessToken = data.access_token;
                document.getElementById("authForm").style.display = "none";
                document.getElementById("migrateBtn").style.display = "block";
                document.querySelector(".progress-container").style.display = "block";
                document.querySelector(".logs").style.display = "block";
                document.querySelector(".status-cards").style.display = "flex";
            } catch (error) {
                console.error("Error during authentication:", error);
                alert(`Authentication failed: ${error.message}`);
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            const emailInput = document.getElementById("email");
            const passwordInput = document.getElementById("password");
            const authenticateBtn = document.getElementById("authenticateBtn");
        
            // Function to check if both fields are filled
            const checkFieldsAndAuthenticate = () => {
                if (emailInput.value && passwordInput.value) {
                    authenticateBtn.click(); // Programmatically click the authenticate button
                }
            };
        
            // Add input event listeners to both fields
            emailInput.addEventListener("input", checkFieldsAndAuthenticate);
            passwordInput.addEventListener("input", checkFieldsAndAuthenticate);
        
            // Existing authentication logic
            authenticateBtn.addEventListener("click", async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
        
                if (!email || !password) {
                    alert("Please enter both email and password.");
                    return;
                }
        
                try {
                    const response = await fetch("/authenticate", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ email, password }),
                    });
        
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || "Authentication failed.");
                    }
        
                    const data = await response.json();
                    accessToken = data.access_token;
                    document.getElementById("authForm").style.display = "none";
                    document.getElementById("migrateBtn").style.display = "block";
                    document.querySelector(".progress-container").style.display = "block";
                    document.querySelector(".logs").style.display = "block";
                    document.querySelector(".status-cards").style.display = "flex";
                } catch (error) {
                    console.error("Error during authentication:", error);
                    alert(`Authentication failed: ${error.message}`);
                }
            });
        });

        async function getCrmContactsUrl() {
            try {
                const response = await fetch('/api/crm-contacts-url');
                if (!response.ok) {
                    throw new Error('Failed to fetch CRM contacts URL');
                }
                const data = await response.json();
                return data.crmContactsUrl;
            } catch (error) {
                console.error('Error fetching CRM contacts URL:', error);
                return null;
            }
        }

        function resetProgressBars() {
            document.getElementById("fetchingProgress").style.width = "0%";
            document.getElementById("migrationProgress").style.width = "0%";
            document.getElementById("fetchingMessage").textContent = "Fetching Users: Not Started";
            document.getElementById("migrationMessage").textContent = "Migration: Not Started";
            document.getElementById("fetchingStatusMessage").textContent = "Pending";
            document.getElementById("migrationStatusMessage").textContent = "Pending";
        }


            document.getElementById("migrateBtn").addEventListener("click", async () => {
                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML = "";
                logsContainer.style.display = "block";

                resetProgressBars();

                try {
                    // Fetch and save users
                    logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Fetching and saving users to staging...</p>`;
                    document.getElementById("fetchingMessage").textContent = "Fetching users...";
                    document.getElementById("fetchingProgress").style.width = "50%";

                    const fetchAndSaveData = await fetchAndSaveUsers(accessToken);

                    if (fetchAndSaveData.success) {
                        document.getElementById("fetchingProgress").style.width = "100%";
                        document.getElementById("fetchingStatusMessage").textContent = "Complete";
                        logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Users fetched and saved successfully.</p>`;
                    } else {
                        document.getElementById("fetchingStatusMessage").textContent = "Failed";
                        logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch and save users.</p>`;
                        return;
                    }

                    // Retrieve users from staging
                    logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Retrieving users from staging database...</p>`;
                    const users = await getUsersFromStaging();
                    logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Retrieved ${users.length} users from staging.</p>`;

                    // Start migration
                    document.getElementById("migrationMessage").textContent = "Starting migration...";
                    document.getElementById("migrationProgress").style.width = "0%";

                    const response = await fetch("/migrate", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ user_ids: users.map(user => user.id) }),
                    });

                    if (!response.ok) {
                        throw new Error("Migration failed");
                    }

                    const data = await response.json();
                    const totalUsers = data.total_records;
                    let processedUsers = 0;

                    for (const result of data.results) {
                        processedUsers++;
                        const progress = (processedUsers / totalUsers) * 100;
                        document.getElementById("migrationProgress").style.width = `${progress}%`;
                        document.getElementById("migrationMessage").textContent = `Migrating user ${result.user_id}...`;

                        logsContainer.innerHTML += `<p><strong>User ID:</strong> ${result.user_id} <br> <strong>Staging Status:</strong> ${result.staging_status} <br><strong>CRM Status:</strong> ${result.crm_status} <br><strong>Action:</strong> ${result.action || "none"} <br>${result.error ? `<strong>Error:</strong> ${result.error}` : ""}</p>`;
                        logsContainer.scrollTop = logsContainer.scrollHeight;

                        // Introduce a small delay to allow the UI to update
                        await new Promise(resolve => setTimeout(resolve, 100)); // 100ms delay
                    }

                    logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Migration Summary:</p><p>Total Records: ${data.total_records}</p><p>Successfully Migrated: ${data.success_count}</p><p>Updated: ${data.update_count}</p><p>Inserted: ${data.insert_count}</p><p>Failed: ${data.error_count}</p>`;
                    logsContainer.scrollTop = logsContainer.scrollHeight;

                    // Populate the migration summary table dynamically
                    const summaryTable = document.getElementById("migrationSummaryTable").getElementsByTagName('tbody')[0];
                    summaryTable.innerHTML = `
                        <tr>
                            <td>${data.entity_name}</td> <!-- Dynamically insert entity name -->
                            <td>${data.total_records}</td>
                            <td>${data.success_count + data.error_count}</td>
                            <td>${data.insert_count}</td>
                            <td>${data.update_count}</td>
                            <td>${data.error_count}</td>
                        </tr>
                    `;

                    // Show the migration summary table
                    document.querySelector(".migration-summary").style.display = "block";


                    const crmContactsUrl = await getCrmContactsUrl();
                    if (crmContactsUrl) {
                        document.getElementById("crmLink").href = crmContactsUrl;
                        document.getElementById("crmLinkContainer").style.display = "flex";
                    } else {
                        console.error('CRM contacts URL is not available');
                    }
                    if (data.excel_file_url) {
                        const excelDownload = document.getElementById("excelDownload");
                        const excelLink = document.getElementById("excelLink");
                        excelLink.href = data.excel_file_url;
                        excelDownload.style.display = "flex";
                    }
                    
                    if (data.error_count === 0) {
                        document.getElementById("migrationStatusMessage").textContent = "Complete";
                    } else {
                        document.getElementById("migrationStatusMessage").textContent = "Partial Success";
                    }

                    setTimeout(resetProgressBars, 1000);
                } catch (error) {
                    console.error("Error:", error);
                    logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred during migration.</p>`;
                    document.getElementById("fetchingMessage").textContent = "Fetching: Error";
                    document.getElementById("migrationMessage").textContent = "Migration: Error";
                }
            });


        async function fetchAndSaveUsers(accessToken) {
            try {
                const response = await fetch("/fetch-and-save-users", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`,
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to fetch and save users');
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error during fetch and save users:", error);
                throw new Error(error.message || 'Error fetching and saving users');
            }
        }

        async function getUsersFromStaging() {
            try {
                const response = await fetch("/users");
                if (!response.ok) {
                    throw new Error('Failed to fetch users from staging');
                }
                const users = await response.json();
                return users;
            } catch (error) {
                console.error("Error fetching users from staging:", error);
                throw new Error('Error fetching users from staging');
            }
        }
    </script>
</body>
</html>