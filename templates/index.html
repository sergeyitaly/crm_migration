<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamics 365 Migration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css"> <!-- Link to external styles.css -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-8">Facillio.de â†’ Dynamics 365 Migration</h1>

        <!-- Authentication Form -->
        <div id="authForm" class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700">Email:</label>
                <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your email" required>
            </div>
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700">Password:</label>
                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your password" required>
            </div>
            <button id="authenticateBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                <i class="fas fa-check"></i> Authenticate
            </button>
        </div>

        <!-- Entity Selection and Fetch Buttons -->
        <div id="entityControls" class="flex justify-center gap-2 mt-4" style="display: none;">
            <!-- Facilioo Entity Section -->
            <div class="bg-white p-4 rounded border text-center">
                <label for="entitySelect" class="block text-xs font-medium text-gray-600 mb-1">Facilioo Entity</label>
                <select id="entitySelect" class="block w-full px-2 py-1 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">-- Select --</option>
                </select>
                <button id="fetchEntityBtn" class="bg-blue-500 text-white w-full py-1 mt-2 rounded hover:bg-blue-600 text-sm">
                    <i class="fas fa-download"></i> Fetch
                </button>
            </div>

            <!-- CRM Entity Section -->
            <div class="bg-white p-4 rounded border text-center">
                <label for="entitySelectCRM" class="block text-xs font-medium text-gray-600 mb-1">CRM Entity</label>
                <select id="entitySelectCRM" class="block w-full px-2 py-1 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">-- Select --</option>
                </select>
                <button id="fetchEntityBtnCRM" class="bg-blue-500 text-white w-full py-1 mt-2 rounded hover:bg-blue-600 text-sm">
                    <i class="fas fa-download"></i> Fetch
                </button>
            </div>
        </div>

<!-- Match Entities Button -->
<div class="text-center mt-4" id="matchControls" style="display: none;">
    <button id="matchEntitiesBtn" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
        <i class="fas fa-exchange-alt"></i> Match Entities
    </button>
</div>

        <!-- Dropdown for Matched Fields -->
        <div class="text-center mt-4" id="matchedFieldsDropdownContainer" style="display: none;">
            <label for="matchedFieldsDropdown" class="block text-sm font-medium text-gray-700">
                Select Matched Fields:
            </label>
            <select id="matchedFieldsDropdown" multiple size="6"
                class="mt-1 block w-160 mx-auto px-3 py-2 border border-gray-400 rounded-lg shadow-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <!-- Options will be populated dynamically -->
            </select>
        </div>

        <div class="text-center mt-4" id="saveMatchingBtnContainer" style="display: none;">
            <button id="saveMatchingBtn" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                Save Matching
            </button>
        </div>
        

        <!-- Migration Button -->
        <div id="migrationControls" class="text-center mt-8" style="display: none;">
            <button id="migrateBtn" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                <i class="fas fa-sync-alt"></i> Start Accounts Migration
            </button>
        </div>

        <!-- Progress Bars -->
        <div id="progressContainer" class="mt-8 max-w-2xl mx-auto" style="display: none;">
            <h3 class="text-xl font-semibold mb-4">Migration Progress</h3>

            <!-- Fetching Users Progress -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span>Fetching</span>
                    <span id="fetchingMessage">Not Started</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="fetchingProgress" class="progress-bar bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Migration Progress -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span>Migration</span>
                    <span id="migrationMessage">Not Started</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="migrationProgress" class="progress-bar bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div id="logsSection" class="mt-8 max-w-2xl mx-auto" style="display: none;">
            <h3 class="text-xl font-semibold mb-4"><i class="fas fa-clipboard-list"></i> Logs</h3>
            <button id="toggleLogs" class="bg-gray-500 text-white py-1 px-3 rounded-md hover:bg-gray-600 transition duration-200">Show Logs</button>
            <div id="logsContainer" class="mt-4 bg-white p-4 rounded-lg shadow-md" style="display: none; max-height: 300px; overflow-y: auto;"></div>
        </div>

        <!-- Migration Summary Table -->
        <div id="migrationSummary" class="mt-8 max-w-2xl mx-auto" style="display: none;">
            <h3 class="text-xl font-semibold mb-4"><i class="fas fa-table"></i> Migration Summary</h3>
            <table id="migrationSummaryTable" class="w-full bg-white rounded-lg shadow-md">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-4 py-2">Entity</th>
                        <th class="px-4 py-2">Source Records</th>
                        <th class="px-4 py-2">Processed Records</th>
                        <th class="px-4 py-2">Created</th>
                        <th class="px-4 py-2">Updated</th>
                        <th class="px-4 py-2">Errors</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Excel Download Link -->
        <div id="excelDownload" class="mt-8 max-w-2xl mx-auto text-center" style="display: none;">
            <a id="excelLink" href="#" download class="text-blue-500 hover:text-blue-600">
                <i class="fas fa-file-excel"></i> Download Excel Export
            </a>
        </div>

        <!-- CRM Link -->
        <div id="crmLinkContainer" class="mt-8 max-w-2xl mx-auto text-center" style="display: none;">
            <a id="crmLink" href="#" class="text-blue-500 hover:text-blue-600">Go to CRM Contacts</a>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center" style="display: none;">
            <div class="loading-spinner h-12 w-12 border-4 border-t-4 border-gray-200 rounded-full"></div>
        </div>
    </div>

    <script>
        let accessToken = null;

        $(document).ready(function () {
            $("#matchedFieldsDropdown").select2({
                placeholder: "Select matched fields",
                allowClear: true,
                width: "25%"
            });
            $("#matchedFieldsDropdown").on("change", function () {
                $("#saveMatchingBtnContainer").toggle($(this).val().length > 0);
            });
            
            $("#saveMatchingBtn").on("click", async function () {
                const selectedFields = $("#matchedFieldsDropdown").val();
                if (!selectedFields || selectedFields.length === 0) {
                    alert("Please select at least one matched field.");
                    return;
                }
                const payload = {
                    matchedFields: selectedFields.map(field => {
                        const parts = field.split(/\s*-\s*/); // Splits on hyphen with or without spaces
                        if (parts.length < 2) {
                            console.error("Invalid field format:", field);
                            return null; // Skip invalid entries
                        }
                        return {
                            selectedFaciliooEntity: parts[0].trim(),
                            selectedCrmEntity: parts[1].trim()
                        };
                    }).filter(item => item !== null) // Remove invalid entries
                };
                

                if (payload.matchedFields.length === 0) {
                    alert("No valid matched fields selected.");
                    return;
                }
                console.log("Payload being sent:", payload); // Debugging line
                try {
                    const response = await fetch("/save-matching-columns", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${accessToken}`
                        },
                        body: JSON.stringify(payload)
                    });
        
                    const result = await response.json();
                    if (response.ok) {alert(result.message);} else {alert(`Error: ${result.detail}`);}
                } catch (error) {
                    console.error("Error saving matching columns:", error);
                    alert("An error occurred while saving matching columns.");
                }
            });


        });

        document.getElementById("toggleLogs").addEventListener("click", function() {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.style.display = logsContainer.style.display === "none" ? "block" : "none";
            this.textContent = logsContainer.style.display === "none" ? "Show Logs" : "Hide Logs";
        });


        function autoScrollLogs() {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.scrollTop = logsContainer.scrollHeight; // Scroll to the bottom
        }

        document.getElementById("authenticateBtn").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            if (!email || !password) {
                alert("Please enter both email and password.");
                return;
            }
            showLoadingSpinner();
            try {
                const response = await fetch("/authenticate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ email, password }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Authentication failed.");
                }

                const data = await response.json();
                accessToken = data.access_token; // Store token globally
                document.getElementById("authForm").style.display = "none";
                document.getElementById("migrationControls").style.display = "block";
                document.getElementById("matchControls").style.display = "block";
                document.getElementById("progressContainer").style.display = "block";
                document.getElementById("logsSection").style.display = "block";
                document.getElementById("entityControls").style.display = "flex";
                await fetchAndPopulateCrmEntities();
            } catch (error) {
                console.error("Error during authentication:", error);
                alert(`Authentication failed: ${error.message}`);
            } finally {hideLoadingSpinner();}
        });

       async function fetchAndPopulateCrmEntities() {
        try {
            const response = await fetch("/crm-entities", {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) {
                throw new Error("Failed to fetch CRM entities");}
            const data = await response.json();
            if (!data.entities || !Array.isArray(data.entities)) {throw new Error("Invalid API response format");}
            const entitySelectCRM = document.getElementById("entitySelectCRM");
            entitySelectCRM.innerHTML = '<option value="">-- Select a CRM Entity --</option>';
            data.entities.forEach(entity => {
                const option = document.createElement("option");
                option.value = entity;
                option.textContent = entity.replace(/-/g, " "); // Replace hyphens with spaces
                entitySelectCRM.appendChild(option);
            });
            console.log("CRM entities loaded successfully.");
        } catch (error) {
            console.error("Error fetching CRM entities:", error);
            alert("Failed to fetch CRM entities. Please try again.");
        }
    }
        document.getElementById("matchEntitiesBtn").addEventListener("click", async () => {
            const faciliooEntitySelect = document.getElementById("entitySelect");
            const crmEntitySelect = document.getElementById("entitySelectCRM");
            const selectedFaciliooEntity = faciliooEntitySelect.value;
            const selectedCrmEntity = crmEntitySelect.value;
            if (!selectedFaciliooEntity || !selectedCrmEntity) {
                alert("Please select both Facilioo and CRM entities.");return;}
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.innerHTML = `<p><i class="fas fa-info-circle"></i> Matching entities: ${selectedFaciliooEntity} and ${selectedCrmEntity}...</p>`;
            autoScrollLogs();
            logsContainer.style.display = "block";
            try {
                const [faciliooResponse, crmResponse] = await Promise.all([
                    fetch(`/fetch-entity-fields?entity_name=${selectedFaciliooEntity}`, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ entity_name: selectedFaciliooEntity })
                    }),
                    fetch(`/crm-entity-fields?entity_name=${selectedCrmEntity}`, {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json",
                        },
                    }),
                ]);
        
                if (!faciliooResponse.ok || !crmResponse.ok) {throw new Error("Failed to fetch entity fields.");}
                const faciliooData = await faciliooResponse.json();
                const crmData = await crmResponse.json();
                if (faciliooData.success && crmData.success) {
                    const faciliooFields = faciliooData.columns;
                    const crmFields = crmData.columns;
                    const isEntirelyPartOf = (field1, field2) => {
                        const lowerField1 = field1.toLowerCase();
                        const lowerField2 = field2.toLowerCase();
                        return lowerField2.includes(lowerField1) || lowerField1.includes(lowerField2);
                    };
                    const matchedFields = [];
                    const uniqueFaciliooFields = [];
                    const uniqueCrmFields = [];
                    faciliooFields.forEach(faciliooField => {
                        let isMatched = false;
                        crmFields.forEach(crmField => {
                            if (faciliooField.toLowerCase() === crmField.toLowerCase()) {
                                // 100% match
                                matchedFields.push({ faciliooField, crmField, isExactMatch: true });
                                isMatched = true;
                            } else if (isEntirelyPartOf(faciliooField, crmField)) {
                                matchedFields.push({ faciliooField, crmField, isExactMatch: false });
                                isMatched = true;
                            }
                        });
                        if (!isMatched) {
                            uniqueFaciliooFields.push(faciliooField); // Unique to Facilioo
                        }
                    });
                    crmFields.forEach(crmField => {
                        if (!faciliooFields.some(faciliooField => 
                            faciliooField.toLowerCase() === crmField.toLowerCase() || 
                            isEntirelyPartOf(faciliooField, crmField))
                        ) {uniqueCrmFields.push(crmField);}
                    });
                    let tableHtml = `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 12px; line-height: 1.2;">
                                        <tr>
                                            <th style="padding: 4px; text-align: left; background-color: #f4f4f4; font-weight: normal;">Facilioo Fields</th>
                                            <th style="padding: 4px; text-align: left; background-color: #f4f4f4; font-weight: normal;">CRM Fields</th>
                                            <th style="padding: 4px; text-align: left; background-color: #f4f4f4; font-weight: normal;">Matched Fields</th>
                                        </tr>`;
                    // Fill table rows with Facilioo, CRM, and matched fields
                    const maxLength = Math.max(uniqueFaciliooFields.length, uniqueCrmFields.length, matchedFields.length);
                    for (let i = 0; i < maxLength; i++) {
                        tableHtml += "<tr>";
                        const faciliooField = uniqueFaciliooFields[i];
                        tableHtml += `<td style="padding: 4px; border: 1px solid #ddd; overflow: hidden; text-overflow: ellipsis;">${
                            faciliooField ? `<span style="color: magenta;">âœ˜ ${faciliooField}</span>` : ''
                        }</td>`;
                        const crmField = uniqueCrmFields[i];
                        tableHtml += `<td style="padding: 4px; border: 1px solid #ddd; overflow: hidden; text-overflow: ellipsis;">${
                            crmField ? `<span style="color: blue;">âœ˜ ${crmField}</span>` : ''
                        }</td>`;
                        // Matched fields column
                        const matchedField = matchedFields[i];
                        tableHtml += `<td style="padding: 4px; border: 1px solid #ddd; overflow: hidden; text-overflow: ellipsis;">${
                            matchedField ? 
                                (matchedField.isExactMatch ? 
                                    `<span style="color: green; font-weight: bold;">âœ” ${matchedField.faciliooField}</span>` : 
                                    `<span style="color: magenta;">${matchedField.faciliooField}</span> - <span style="color: blue;">${matchedField.crmField}</span>`) : 
                                ''
                        }</td>`;
                        tableHtml += "</tr>";
                    }
                    tableHtml += "</table>";
                    logsContainer.innerHTML += tableHtml;
                    autoScrollLogs();
                // Populate the dropdown with matched fields
                const matchedFieldsDropdown = document.getElementById("matchedFieldsDropdown");
                matchedFieldsDropdown.innerHTML = ""; // Clear existing options
                matchedFields.forEach(matchedField => {
                    const option = document.createElement("option");
                    option.value = `${matchedField.faciliooField}-${matchedField.crmField}`;
                    option.textContent = matchedField.isExactMatch ? 
                        `âœ” ${matchedField.faciliooField}` : 
                        `${matchedField.faciliooField} - ${matchedField.crmField}`;
                    matchedFieldsDropdown.appendChild(option);
                });
                document.getElementById("matchedFieldsDropdown").addEventListener("change", function () {
                    const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
                    console.log("Selected Matched Fields:", selectedOptions);
                });
                document.getElementById("matchedFieldsDropdownContainer").style.display = "block";
                } else {
                    logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch entity fields.</p>`;
                    autoScrollLogs();
                }
            } catch (error) {
                console.error("Error:", error);
                logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred while matching entities.</p>`;
                autoScrollLogs();
            }
        });        

        document.addEventListener("DOMContentLoaded", () => {
            if (accessToken) {fetchAndPopulateCrmEntities();}
        });

        document.getElementById("migrateBtn").addEventListener("click", async () => {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.innerHTML = "";
            logsContainer.style.display = "block";
            resetProgressBars();
            showLoadingSpinner();
            try {
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Fetching and saving users to staging...</p>`;
                document.getElementById("fetchingMessage").textContent = "Fetching ...";
                document.getElementById("fetchingProgress").style.width = "50%";
                const fetchAndSaveData = await fetchAndSaveUsers(accessToken);
                if (fetchAndSaveData.success) {
                    document.getElementById("fetchingProgress").style.width = "100%";
                    document.getElementById("fetchingStatusMessage").textContent = "Complete";
                    logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Users fetched and saved successfully.</p>`;
                } else {
                    document.getElementById("fetchingStatusMessage").textContent = "Failed";
                    logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch and save users.</p>`;
                    return;
                }
                // Retrieve users from staging
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Retrieving users from staging database...</p>`;
                const users = await getUsersFromStaging();
                logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Retrieved ${users.length} users from staging.</p>`;
                document.getElementById("migrationMessage").textContent = "Starting migration...";
                document.getElementById("migrationProgress").style.width = "0%";
                const response = await fetch("/migrate", {
                    method: "POST",
                    headers: {"Content-Type": "application/json",},
                    body: JSON.stringify({ user_ids: users.map(user => user.id) }),
                });
                if (!response.ok) {throw new Error("Migration failed");}
                const data = await response.json();
                const totalUsers = data.total_records;
                let processedUsers = 0;
                for (const result of data.results) {
                    processedUsers++;
                    const progress = (processedUsers / totalUsers) * 100;
                    document.getElementById("migrationProgress").style.width = `${progress}%`;
                    document.getElementById("migrationMessage").textContent = `Migrating user ${result.user_id}...`;
                    logsContainer.innerHTML += `<p><strong>User ID:</strong> ${result.user_id} <br> <strong>Staging Status:</strong> ${result.staging_status} <br><strong>CRM Status:</strong> ${result.crm_status} <br><strong>Action:</strong> ${result.action || "none"} <br>${result.error ? `<strong>Error:</strong> ${result.error}` : ""}</p>`;
                    autoScrollLogs();
                    await new Promise(resolve => setTimeout(resolve, 100)); // 100ms delay
                }
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Migration Summary:</p><p>Total Records: ${data.total_records}</p><p>Successfully Migrated: ${data.success_count}</p><p>Updated: ${data.update_count}</p><p>Inserted: ${data.insert_count}</p><p>Failed: ${data.error_count}</p>`;
                autoScrollLogs();
                const summaryTable = document.getElementById("migrationSummaryTable").getElementsByTagName('tbody')[0];
                summaryTable.innerHTML = `
                    <tr>
                        <td class="px-4 py-2">${data.entity_name}</td>
                        <td class="px-4 py-2">${data.total_records}</td>
                        <td class="px-4 py-2">${data.success_count + data.error_count}</td>
                        <td class="px-4 py-2">${data.insert_count}</td>
                        <td class="px-4 py-2">${data.update_count}</td>
                        <td class="px-4 py-2">${data.error_count}</td>
                    </tr>
                `;

                // Show the migration summary table
                document.getElementById("migrationSummary").style.display = "block";

                const crmContactsUrl = await getCrmContactsUrl();
                if (crmContactsUrl) {
                    document.getElementById("crmLink").href = crmContactsUrl;
                    document.getElementById("crmLinkContainer").style.display = "block";
                } else {console.error('CRM contacts URL is not available');}
                if (data.excel_file_url) {
                    const excelLink = document.getElementById("excelLink");
                    excelLink.href = data.excel_file_url;
                    document.getElementById("excelDownload").style.display = "block";
                }
                if (data.error_count === 0) {document.getElementById("migrationStatusMessage").textContent = "Complete";} else {document.getElementById("migrationStatusMessage").textContent = "Partial Success";}

                setTimeout(resetProgressBars, 1000);
            } catch (error) {
                console.error("Error:", error);
                logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred during migration.</p>`;
                document.getElementById("fetchingMessage").textContent = "Fetching: Error";
                document.getElementById("migrationMessage").textContent = "Migration: Error";
            } finally {hideLoadingSpinner();}
        });
        async function fetchEntitiesList() {
            try {
                const response = await fetch("/facilioo-entities");
                if (!response.ok) {
                    throw new Error("Failed to fetch entities list");
                }
                const entities = await response.json();
                return entities;
            } catch (error) {
                console.error("Error fetching entities list:", error);
                return []; // Return an empty array or handle the error as needed
            }
        }
        // Fetch data for the selected entity
        async function fetchEntityData(entityName) {
            try {
                const response = await fetch(`/fetch-and-save-entity?entity_name=${entityName}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {throw new Error("Failed to fetch entity data");}
                const data = await response.json();return data;
            } catch (error) {console.error("Error fetching entity data:", error);throw error;}
        }
        document.getElementById("fetchEntityBtnCRM").addEventListener("click", async () => {
            const entitySelect = document.getElementById("entitySelectCRM");
            const selectedEntity = entitySelect.value;
            if (!selectedEntity) {alert("Please select a CRM entity.");return;}
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.innerHTML = `<p><i class="fas fa-info-circle"></i> Fetching column names for CRM entity: ${selectedEntity}...</p>`;
            autoScrollLogs();
            logsContainer.style.display = "block";
            try {
                const response = await fetch(`/crm-entity-fields?entity_name=${selectedEntity}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {throw new Error("Failed to fetch CRM entity fields");}
                const data = await response.json();
                if (data.success) {
                    logsContainer.innerHTML += `<p><i class="fas fa-list"></i> Entity Columns:</p>`;
                    logsContainer.innerHTML += `<pre>${data.columns.join("\n")}</pre>`; // Display columns in the logs section
                    autoScrollLogs();
                } else {logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch columns for ${selectedEntity}.</p>`;autoScrollLogs();}
            } catch (error) {
                console.error("Error:", error);
                logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred while fetching columns for ${selectedEntity}.</p>`;
                autoScrollLogs();
            }
        });

        // Event listener for the "Fetch Entity Data" button
        document.getElementById("fetchEntityBtn").addEventListener("click", async () => {
            const entitySelect = document.getElementById("entitySelect");
            const selectedEntity = entitySelect.value;
            if (!selectedEntity) {
                alert("Please select an entity.");
                return;}
            showLoadingSpinner();
            try {
                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML = "";
                logsContainer.style.display = "block";
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Fetching data for entity: ${selectedEntity}...</p>`;
                autoScrollLogs();
                document.getElementById("fetchingMessage").textContent = `Fetching ${selectedEntity}...`;
                document.getElementById("fetchingProgress").style.width = "0%";
                const eventSource = new EventSource(`/stream-progress?entity_name=${selectedEntity}`);
                eventSource.onmessage = function(event) {
                    const progress = parseInt(event.data);
                    document.getElementById("fetchingProgress").style.width = `${progress}%`;
                    document.getElementById("fetchingMessage").textContent = `Fetching ${selectedEntity}... ${progress}%`;
                    if (progress === 100) {
                        eventSource.close();
                        document.getElementById("fetchingStatusMessage").textContent = "Complete";
                        logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Data fetched and saved successfully for ${selectedEntity}.</p>`;
                        autoScrollLogs();
                        fetchTotalRows(selectedEntity);
                        setTimeout(() => {
                            document.getElementById("fetchingProgress").style.width = "0%";
                            document.getElementById("fetchingMessage").textContent = "Fetching: Not Started";
                        }, 1000);
                    }
                };

                const response = await fetch(`/fetch-and-save-entity?entity_name=${selectedEntity}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json",
                    },
                });

                if (!response.ok) {throw new Error("Failed to fetch entity data");}
                const data = await response.json();
                if (data.success) {
                    logsContainer.innerHTML += `<p><i class="fas fa-list"></i> Entity Columns:</p>`;
                    logsContainer.innerHTML += `<pre>${data.columns.join("\n")}</pre>`; // Display columns in the logs section
                    autoScrollLogs();
                } else {
                    document.getElementById("fetchingStatusMessage").textContent = "Failed";
                    logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch and save data for ${selectedEntity}.</p>`;
                    autoScrollLogs();
                }
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("fetchingStatusMessage").textContent = "Error";
                logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred while fetching data for ${selectedEntity}.</p>`;
                autoScrollLogs();
            } finally {hideLoadingSpinner();}
        });

        // Fetch and populate Facilioo entities dropdown
        async function populateEntityDropdown() {
            try {
                const response = await fetch("/facilioo-entities");
                if (!response.ok) {throw new Error("Failed to fetch entities list");}
                const entities = await response.json();
                const entitySelect = document.getElementById("entitySelect");
                entitySelect.innerHTML = '<option value="">-- Select a Facilioo Entity --</option>';
                entities.forEach(entity => {
                    const option = document.createElement("option");
                    option.value = entity;
                    option.textContent = entity.replace(/-/g, " "); 
                    entitySelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error fetching entities list:", error);
                alert("Failed to fetch Facilioo entities. Please try again.");
            }
        }

        async function fetchTotalRows(entityName) {
            try {
                const response = await fetch(`/get-total-rows?entity_name=${entityName}`);
                if (!response.ok) {throw new Error("Failed to fetch total rows");}
                const data = await response.json();
                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML += `<p><i class="fas fa-database"></i> Total Rows Added: ${data.total_records}</p>`;
                autoScrollLogs();
            } catch (error) {console.error("Error fetching total rows:", error);}
        }

        document.addEventListener("DOMContentLoaded", () => {populateEntityDropdown();});
        async function fetchAndSaveUsers(accessToken) {
            try {
                const response = await fetch("/fetch-and-save-users", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`,
                    },
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to fetch and save users');
                }
                const data = await response.json();return data;
            } catch (error) {
                console.error("Error during fetch and save users:", error);
                throw new Error(error.message || 'Error fetching and saving users');
            }
        }

        async function getUsersFromStaging() {
            try {
                const response = await fetch("/users");
                if (!response.ok) {throw new Error('Failed to fetch users from staging');}
                const users = await response.json();return users;
            } catch (error) {
                console.error("Error fetching users from staging:", error);
                throw new Error('Error fetching users from staging');
            }
        }

        async function getCrmContactsUrl() {
            try {
                const response = await fetch('/api/crm-contacts-url');
                if (!response.ok) {throw new Error('Failed to fetch CRM contacts URL');}
                const data = await response.json();
                return data.crmContactsUrl;
            } catch (error) {console.error('Error fetching CRM contacts URL:', error);return null;}
        }
        function resetProgressBars() {
            document.getElementById("fetchingProgress").style.width = "0%";
            document.getElementById("migrationProgress").style.width = "0%";
            document.getElementById("fetchingMessage").textContent = "Fetching : Not Started";
            document.getElementById("migrationMessage").textContent = "Migration: Not Started";
            document.getElementById("fetchingStatusMessage").textContent = "Pending";
            document.getElementById("migrationStatusMessage").textContent = "Pending";
        }
        function showLoadingSpinner() {document.getElementById("loadingSpinner").style.display = "flex";}
        function hideLoadingSpinner() {document.getElementById("loadingSpinner").style.display = "none";}
    </script>
</body>
</html>