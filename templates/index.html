<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamics 365 Migration</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/ico/favicon.ico">
    <link rel="apple-touch-icon" sizes="57x57" href="/static/ico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/static/ico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/static/ico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/static/ico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/static/ico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/static/ico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/ico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/ico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/ico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/ico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/ico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/ico/favicon-16x16.png">
    <link rel="manifest" href="/static/ico/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/static/ico/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="static/style.css"> <!-- Link to external styles.css -->

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4">
        <h1 id="clickableHeading" class="text-3xl font-bold text-center mb-8 cursor-pointer hover:text-blue-600">
            Facillio.de → Dynamics 365 Migration
        </h1>
        <!-- Authentication Form -->
        <div id="authForm" class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700">Email:</label>
                <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your email" required>
            </div>
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700">Password:</label>
                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your password" required>
            </div>
            <button id="authenticateBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                <i class="fas fa-check"></i> Authenticate
            </button>
        </div>

        <!-- Entity Selection and Fetch Buttons -->
        <div id="entityControls" class="flex justify-center gap-2 mt-4" style="display: none;">
            <!-- Facilioo Entity Section -->
            <div class="bg-white p-4 rounded border text-center">
                <label for="entitySelect" class="block text-xs font-medium text-gray-600 mb-1">Facilioo Entity</label>
                <select id="entitySelect" class="block w-full px-2 py-1 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">-- Select --</option>
                </select>
                <button id="fetchEntityBtn" class="bg-blue-500 text-white w-full py-1 mt-2 rounded hover:bg-blue-600 text-sm">
                    <i class="fas fa-download"></i> Fetch to DB and Excel
                </button>
            </div>

            <!-- CRM Entity Section -->
            <div class="bg-white p-4 rounded border text-center">
                <label for="entitySelectCRM" class="block text-xs font-medium text-gray-600 mb-1">CRM Entity</label>
                <select id="entitySelectCRM" class="block w-full px-2 py-1 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">-- Select --</option>
                </select>
                <button id="fetchEntityBtnCRM" class="bg-blue-500 text-white w-full py-1 mt-2 rounded hover:bg-blue-600 text-sm">
                    <i class="fas fa-download"></i> Show Fields
                </button>
            </div>
        </div>

<!-- Match Entities Button -->
<div class="text-center mt-4" id="matchControls" style="display: none;">
    <button id="matchEntitiesBtn" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
        <i class="fas fa-exchange-alt"></i> Match Entities
    </button>
</div>

        <!-- Dropdown for Matched Fields -->
        <div class="text-center mt-4" id="matchedFieldsDropdownContainer" style="display: none;">
            <label for="matchedFieldsDropdown" class="block text-sm font-medium text-gray-700">
                Select Matched Fields:
            </label>
            <select id="matchedFieldsDropdown" multiple size="6"
                class="mt-1 block w-160 mx-auto px-3 py-2 border border-gray-400 rounded-lg shadow-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <!-- Options will be populated dynamically -->
            </select>
        </div>

        <div class="text-center mt-4" id="saveMatchingBtnContainer" style="display: none;">
            <button id="saveMatchingBtn" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                Save Matching
            </button>
        </div>
        

        <!-- Migration Button -->
        <div id="migrationControls" class="text-center mt-8" style="display: none;">
            <button id="migrateBtn" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-200" style="display: none;">
                <i class="fas fa-sync-alt"></i> Start Accounts Migration
            </button>
            <button id="migrateEntityBtn" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                <i class="fas fa-sync-alt"></i> Migration
            </button>
        </div>



        <!-- Progress Bars -->
        <div id="progressContainer" class="mt-8 max-w-2xl mx-auto" style="display: none;">
            <h3 class="text-xl font-semibold mb-4">Migration Progress</h3>

            <!-- Fetching Users Progress -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span>Fetching</span>
                    <span id="fetchingMessage">Not Started</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="fetchingProgress" class="progress-bar bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Migration Progress -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span>Migration</span>
                    <span id="migrationMessage">Not Started</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="migrationProgress" class="progress-bar bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div id="logsSection" class="mt-8 max-w-2xl mx-auto" style="display: none;">
            <h3 class="text-xl font-semibold mb-4"><i class="fas fa-clipboard-list"></i> Logs</h3>
            <button id="toggleLogs" class="bg-gray-500 text-white py-1 px-3 rounded-md hover:bg-gray-600 transition duration-200">Show Logs</button>
            <div id="logsContainer" class="mt-4 bg-white p-4 rounded-lg shadow-md" style="display: none; max-height: 300px; overflow-y: auto;"></div>
        </div>

        <!-- Migration Summary Table -->
        <div id="migrationSummary" class="mt-8 max-w-2xl mx-auto" style="display: none;">
            <h3 class="text-xl font-semibold mb-4"><i class="fas fa-table"></i> Migration Summary</h3>
            <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                <table id="migrationSummaryTable" class="w-full">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="px-4 py-2">Entity</th>
                            <th class="px-4 py-2">Source Records</th>
                            <th class="px-4 py-2">Processed Records</th>
                            <th class="px-4 py-2">Created</th>
                            <th class="px-4 py-2">Updated</th>
                            <th class="px-4 py-2">Errors</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>


        <!-- Metrics Section -->
        <div id="metricsSection" class="mt-8 max-w-2xl mx-auto" style="display: none;">
            <h3 class="text-xl font-semibold mb-4"><i class="fas fa-chart-line"></i> Migration Metrics</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Source and Target -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h4 class="text-lg font-semibold mb-2">Source & Target</h4>
                    <p><strong>Source:</strong> <span id="sourceEntity">N/A</span></p>
                    <p><strong>Target:</strong> <span id="targetEntity">N/A</span></p>
                </div>

                <!-- Errors -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h4 class="text-lg font-semibold mb-2">Errors</h4>
                    <p><strong>Total Errors:</strong> <span id="totalErrors">0</span></p>
                    <p><strong>Failed Fields:</strong> <span id="failedFields">0</span></p>
                </div>
            <!-- Performance Section -->
            <div class="bg-white p-4 rounded-lg shadow-md relative group">
                <h4 class="text-lg font-semibold mb-2">Performance</h4>
                <p><strong>Data Quality:</strong> <span id="dataQuality">0%</span></p>
                <p><strong>Velocity:</strong> <span id="migrationVelocity">0 records/sec</span></p>
                <!-- Compact Popup for Formulas -->
                <div id="formulaPopup" class="hidden absolute bg-gray-50 p-1 rounded-md shadow-md border border-gray-300 w-40 text-xs z-10 group-hover:block" style="bottom: 120%; left: 50%; transform: translateX(-50%);">
                    <p><strong>Data Quality:</strong></p>
                    <p>((Migrated - Errors) / Migrated) × 100</p>
                    <p class="mt-1"><strong>Velocity:</strong></p>
                    <p>Migrated / Time (sec)</p>
                </div>
            </div>

            </div>
        </div> 

        <!-- Excel Download Link -->
        <div id="excelDownload" class="mt-8 max-w-2xl mx-auto text-center" style="display: none;">
            <a id="excelLink" href="#" target="_blank" class="text-blue-500 hover:text-blue-600">
                <i class="fas fa-file-excel"></i> View Excel Export
            </a>
        </div>

        <!-- CRM Link -->
        <div id="crmLinkContainer" class="mt-8 max-w-2xl mx-auto text-center" style="display: none;">
            <a id="crmLink" href="#" target="_blank" class="text-blue-500 hover:text-blue-600">Go to CRM entity</a>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50" style="display: none;">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>
    </div>

    <script>
        let accessToken = null;

        $(document).ready(function () {

            let isDropdownChanged = false; // Flag to track dropdown changes
            const saveMatchingBtn = $("#saveMatchingBtn");
            saveMatchingBtn.hide();
            const migrateEntityBtn = $("#migrateEntityBtn");
            migrateEntityBtn.hide();

            $("#matchedFieldsDropdown").select2({
                placeholder: "Select matched fields",
                allowClear: true,
                width: "65%"
                //width: "resolve"  
            });

            $("#matchedFieldsDropdown").on("change", function () {
                // Toggle the visibility of the save button based on whether any fields are selected
                $("#saveMatchingBtnContainer").toggle($(this).val().length > 0);
                isDropdownChanged = true; // Set the flag to true when dropdown changes
                saveMatchingBtn.show(); // Show the Save Matching button
            
                // Highlight the first selected option in the dropdown
                highlightFirstSelectedOption();
            });
            
            $("#matchedFieldsDropdown").on("select2:select", function (e) {
                // Highlight the first selected option in the dropdown
                highlightFirstSelectedOption();
            });
            
            $("#matchedFieldsDropdown").on("select2:unselect", function (e) {
                // Highlight the first selected option in the dropdown
                highlightFirstSelectedOption();
            });
            
            // Helper function to highlight the first selected option
            function highlightFirstSelectedOption() {
                // Reset all selected options' background color
                $("#matchedFieldsDropdown option").css("background-color", "");
            
                // Get the first selected option and highlight it
                const firstSelectedOption = $("#matchedFieldsDropdown option:selected").first();
                if (firstSelectedOption.length) {
                    firstSelectedOption.css("background-color", "yellow");
                }
            
                // Reset all Select2 choice backgrounds
                $(".select2-selection__choice").css("background-color", "");
            
                // Highlight the first Select2 choice
                const firstSelect2Choice = $(".select2-selection__choice").first();
                if (firstSelect2Choice.length) {
                    firstSelect2Choice.css("background-color", "yellow");
                }
            }

            $("#saveMatchingBtn").on("click", async function () {
                const selectedFaciliooEntity = $("#entitySelect").val();
                const selectedCrmEntity = $("#entitySelectCRM").val();
                const selectedFields = $("#matchedFieldsDropdown").val();
                const logsContainer = document.getElementById("logsContainer");
                if (!selectedFaciliooEntity || !selectedCrmEntity) {logsContainer.innerHTML += `<p style="color: red;">❌ Please select both Facilioo and CRM entities.</p>`;autoScrollLogs();return;}            
                if (!selectedFields || selectedFields.length === 0) {logsContainer.innerHTML += `<p style="color: red;">❌ Please select at least one matched field.</p>`;autoScrollLogs();return;}
                const nonEmptyFields = selectedFields.filter(field => field && field.trim());
                if (nonEmptyFields.length === 0) {logsContainer.innerHTML += `<p style="color: red;">❌ Please select at least one valid matched field.</p>`;autoScrollLogs();return;}
                const payload = {
                    selectedFaciliooEntity,
                    selectedCrmEntity,
                    matchedFields: nonEmptyFields
                };
                logsContainer.innerHTML += `<p>📤 Sending payload: ${JSON.stringify(payload)}</p>`;            
                autoScrollLogs();            
                document.getElementById("migrationSummary").style.display = "none";

                try {
                    const response = await fetch("/save-matching-columns", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${accessToken}`
                        },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        logsContainer.innerHTML += `<p style="color: green;">✅ ${result.message}</p>`;autoScrollLogs();
                        migrateEntityBtn.show();
                    } else {logsContainer.innerHTML += `<p style="color: red;">❌ Error: ${result.detail}</p>`;autoScrollLogs();
                    }
                    isDropdownChanged = false;
                    saveMatchingBtn.hide();
                    matchedFieldsDropdownContainer.style.display = "none";
                    migrateEntityBtn.show();

        

                } catch (error) {
                    console.error("Error saving matching columns:", error);
                    logsContainer.innerHTML += `<p style="color: red;">❌ An error occurred while saving matching columns.</p>`;autoScrollLogs();
                }
            });
                        


            async function fetchAndDisplayMatchingFields() {
                const selectedFaciliooEntity = $("#entitySelect").val();
                const selectedCrmEntity = $("#entitySelectCRM").val();
                const logsContainer = document.getElementById("logsContainer");
                const migrateEntityBtn = $("#migrateEntityBtn");
                const matchedFieldsDropdownContainer = document.getElementById("matchedFieldsDropdownContainer");
                const matchedFieldsDropdown = document.getElementById("matchedFieldsDropdown");
                document.getElementById("migrationSummary").style.display = "none";
                if (!selectedFaciliooEntity || !selectedCrmEntity) {
                    logsContainer.innerHTML = `<strong>Please select both entities to compare.</strong>`;
                    return;
                }
            
                try {
                    $("#logsContainer").show();
                    const response = await fetch(`/get-matching-fields?selectedFaciliooEntity=${selectedFaciliooEntity}&selectedCrmEntity=${selectedCrmEntity}`, {
                        method: "GET",
                        headers: { "Authorization": `Bearer ${accessToken}` }
                    });
                    const result = await response.json();
            
                    if (response.ok) {
                        const matchedFields = result.matched_fields || [];
            
                        if (matchedFields.length > 0) {
                            // Show the dropdown and populate it with matched fields
                            matchedFieldsDropdown.innerHTML = ""; // Clear existing options
                            matchedFields.forEach(match => {
                                const [faciliooField, crmField] = match.split("-");
                                const option = document.createElement("option");
                                option.value = match;
                                option.textContent = `${faciliooField} - ${crmField}`;
                                //matchedFieldsDropdown.appendChild(option);
                                matchedFieldsDropdown.prepend(option);  
                            });
                            matchedFieldsDropdownContainer.style.display = "none"; // Hide the dropdown container

                            // Display the table with matched fields
                            let tableHTML = `
                                <strong>Comparing:</strong> 
                                <br>Facilioo Entity: <b>${selectedFaciliooEntity}</b> 
                                <br>CRM Entity: <b>${selectedCrmEntity}</b>
                                <hr>
                                <table border="1" cellspacing="0" cellpadding="5" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background-color: #f2f2f2;">
                                            <th>Facilioo Entity</th>
                                            <th>CRM Entity</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
            
                            matchedFields.forEach(match => {
                                const [faciliooField, crmField] = match.split("-");
                                tableHTML += `
                                    <tr>
                                        <td>${faciliooField}</td>
                                        <td>${crmField}</td>
                                    </tr>`;
                            });
            
                            tableHTML += `</tbody></table>`;
                            logsContainer.innerHTML = tableHTML;
                            migrateEntityBtn.show();
                        } else {
                            // Hide the dropdown and display a message
                            matchedFieldsDropdownContainer.style.display = "none"; // Hide the dropdown container
                            logsContainer.innerHTML = `
                                <strong>Comparing:</strong> 
                                <br>Facilioo Entity: <b>${selectedFaciliooEntity}</b> 
                                <br>CRM Entity: <b>${selectedCrmEntity}</b>
                                <hr>
                                No matching fields found.
                            `;
                            migrateEntityBtn.hide();
                        }
            
                        autoScrollLogs();
                    } else {
                        alert(`Error: ${result.detail}`);
                    }
                } catch (error) {
                    console.error("Error fetching matching fields:", error);
                }
            }
            
            $("#entitySelect, #entitySelectCRM").on("change", fetchAndDisplayMatchingFields);
            $("#entitySelectCRM").on("change", function () {
                const selectedCrmEntity = $(this).val(); // Get the selected CRM entity
                if (selectedCrmEntity) {
                    fetchCRMEntityLink(selectedCrmEntity); // Call the function with selected value
                }
            });
            
            document.getElementById("matchEntitiesBtn").addEventListener("click", async () => {
                const faciliooEntitySelect = document.getElementById("entitySelect");
                const crmEntitySelect = document.getElementById("entitySelectCRM");
                const selectedFaciliooEntity = faciliooEntitySelect.value;
                const selectedCrmEntity = crmEntitySelect.value;
            
                if (!selectedFaciliooEntity || !selectedCrmEntity) {
                    alert("Please select both Facilioo and CRM entities.");
                    return;
                }
            
                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML = `<p><i class="fas fa-info-circle"></i> Matching entities: ${selectedFaciliooEntity} and ${selectedCrmEntity}...</p>`;
                autoScrollLogs();
                logsContainer.style.display = "block";
                document.getElementById("migrationSummary").style.display = "none";
                showLoadingSpinner();
            
                try {
                    // Fetch entity fields and matched fields
                    const [faciliooResponse, crmResponse, matchedFieldsResponse] = await Promise.all([
                        fetch(`/fetch-entity-fields?entity_name=${selectedFaciliooEntity}`, {
                            method: "POST",
                            headers: {
                                "Authorization": `Bearer ${accessToken}`,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ entity_name: selectedFaciliooEntity }),
                        }),
                        fetch(`/crm-entity-fields?entity_name=${selectedCrmEntity}`, {
                            method: "GET",
                            headers: {
                                "Authorization": `Bearer ${accessToken}`,
                                "Content-Type": "application/json",
                            },
                        }),
                        fetch(`/get-matching-fields?selectedFaciliooEntity=${selectedFaciliooEntity}&selectedCrmEntity=${selectedCrmEntity}`, {
                            method: "GET",
                            headers: {
                                "Authorization": `Bearer ${accessToken}`,
                            },
                        }),
                    ]);
            
                    if (!faciliooResponse.ok || !crmResponse.ok || !matchedFieldsResponse.ok) {
                        throw new Error("Failed to fetch entity fields or matched fields.");
                    }
            
                    const faciliooData = await faciliooResponse.json();
                    const crmData = await crmResponse.json();
                    const matchedFieldsData = await matchedFieldsResponse.json();
            
                    if (faciliooData.success && crmData.success && matchedFieldsData.success) {
                        const faciliooFields = faciliooData.columns;
                        //const crmFields = crmData.columns;
                        const crmFields = crmData.columns.map(column => {
                            if (column.mandatory) {
                                return `${column.name} *`; // Red color for required fields
                            } else if (column.upsert) {
                                return `${column.name} +`; // Green color for upsert fields with a + sign
                            } else {
                                return column.name; // Default column without additional symbols
                            }
                        });
                        const existingMatchedFields = matchedFieldsData.matched_fields || [];
            
                        const isEntirelyPartOf = (field1, field2) => {
                            const lowerField1 = field1.toLowerCase();
                            const lowerField2 = field2.toLowerCase();
                            return lowerField2.includes(lowerField1) || lowerField1.includes(lowerField2);
                        };
            
                        const matchedFields = [];
                        const uniqueFaciliooFields = [];
                        const uniqueCrmFields = [];
            
                        // Generate all possible combinations
                        const allCombinations = [];
                        faciliooFields.forEach(faciliooField => {
                            crmFields.forEach(crmField => {
                                allCombinations.push({
                                    faciliooField,
                                    crmField,
                                    isExactMatch: faciliooField.toLowerCase() === crmField.toLowerCase(),
                                });
                            });
                        });
            
                        faciliooFields.forEach(faciliooField => {
                            let isMatched = false;
                            crmFields.forEach(crmField => {
                                if (faciliooField.toLowerCase() === crmField.toLowerCase()) {
                                    matchedFields.push({ faciliooField, crmField, isExactMatch: true });
                                    isMatched = true;
                                } else if (isEntirelyPartOf(faciliooField, crmField)) {
                                    matchedFields.push({ faciliooField, crmField, isExactMatch: false });
                                    isMatched = true;
                                }
                            });
                            if (!isMatched) {
                                uniqueFaciliooFields.push(faciliooField);
                            }
                        });
            
                        crmFields.forEach(crmField => {
                            if (!faciliooFields.some(faciliooField =>
                                faciliooField.toLowerCase() === crmField.toLowerCase() ||
                                isEntirelyPartOf(faciliooField, crmField))
                            ) {
                                uniqueCrmFields.push(crmField);
                            }
                        });
                        let tableHtml = `
                        <table style="width: 100%; border-collapse: collapse; table-layout: auto; font-size: 12px; line-height: 1.2; word-wrap: break-word;">
                            <tr>
                                <th style="padding: 4px; text-align: left; background-color: #f4f4f4; font-weight: normal;">Facilioo Fields</th>
                                <th style="padding: 4px; text-align: left; background-color: #f4f4f4; font-weight: normal;">CRM Fields</th>
                                <th style="padding: 4px; text-align: left; background-color: #f4f4f4; font-weight: normal;">Matched Fields</th>
                            </tr>
                    `;
                    
                    // Example rows (replace with your actual data)
                    const maxLength = Math.max(uniqueFaciliooFields.length, uniqueCrmFields.length, matchedFields.length);
                    for (let i = 0; i < maxLength; i++) {
                        tableHtml += `
                            <tr>
                                <td style="padding: 4px; border: 1px solid #ddd; word-wrap: break-word;">
                                    ${uniqueFaciliooFields[i] ? `<span style="color: magenta;">✘ ${uniqueFaciliooFields[i]}</span>` : ''}
                                </td>
                                <td style="padding: 4px; border: 1px solid #ddd; word-wrap: break-word;">
                                    ${uniqueCrmFields[i] ? `<span style="color: blue;">✘ ${uniqueCrmFields[i]}</span>` : ''}
                                </td>
                                <td style="padding: 4px; border: 1px solid #ddd; word-wrap: break-word;">
                                    ${matchedFields[i] ? 
                                        (matchedFields[i].isExactMatch ? 
                                            `<span style="color: green; font-weight: bold;">✔ ${matchedFields[i].faciliooField}</span>` : 
                                            `<span style="color: magenta;">${matchedFields[i].faciliooField}</span> - <span style="color: blue;">${matchedFields[i].crmField}</span>`) : 
                                        ''}
                                </td>
                            </tr>
                        `;
                    }
                    
                    tableHtml += `</table>`;
                    
                    // Append the table to the logsContainer
                    logsContainer.innerHTML += tableHtml;
                    autoScrollLogs();
            
                        // Populate the dropdown with all possible field pairs
                        const matchedFieldsDropdown = document.getElementById("matchedFieldsDropdown");
                        matchedFieldsDropdown.innerHTML = "";
            
                        allCombinations.forEach(combination => {
                            const option = document.createElement("option");
                            option.value = `${combination.faciliooField}-${combination.crmField}`;
                            option.textContent = combination.isExactMatch ?
                                `✔ ${combination.faciliooField}` :
                                `${combination.faciliooField} - ${combination.crmField}`;
                            if (existingMatchedFields.includes(`${combination.faciliooField}-${combination.crmField}`)) {
                                option.selected = true;
                            }
                            matchedFieldsDropdown.prepend(option);
                            //matchedFieldsDropdown.appendChild(option);
                        });
            
                        document.getElementById("matchedFieldsDropdownContainer").style.display = matchedFields.length > 0 ? "block" : "none";
            
                    } else {
                        logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch entity fields.</p>`;
                        autoScrollLogs();
                    }
                } catch (error) {
                    console.error("Error:", error);
                    logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred while matching entities.</p>`;
                    autoScrollLogs();
                }
                hideLoadingSpinner();
            });
                    



// do not delete });               

    });
        
            async function fetchCRMEntityLink(entityName) {
                try {
                    const response = await fetch(`/crm-entity-link?entity_name=${entityName}`, {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${localStorage.getItem("access_token")}`, // Assuming you store the token in localStorage
                            "Content-Type": "application/json"
                        }
                    });
            
                    if (!response.ok) {
                        throw new Error(`Failed to fetch CRM entity link: ${response.statusText}`);
                    }
            
                    const data = await response.json();
                    const crmLinkContainer = document.getElementById("crmLinkContainer");
                    const crmLink = document.getElementById("crmLink");
            
                    if (data.crm_entity_link) {
                        crmLink.href = data.crm_entity_link;
                        crmLinkContainer.style.display = "block";
                    } else {
                        console.error("No CRM entity link found in response");
                    }
                } catch (error) {
                    console.error("Error fetching CRM entity link:", error);
                }
            }

            document.getElementById("toggleLogs").addEventListener("click", function() {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.style.display = logsContainer.style.display === "none" ? "block" : "none";
            this.textContent = logsContainer.style.display === "none" ? "Show Logs" : "Hide Logs";
        });

        document.getElementById("migrateEntityBtn").addEventListener("click", async () => {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.innerHTML = "";
            logsContainer.style.display = "block";
            document.getElementById("migrationSummary").style.display = "none";
            document.getElementById("metricsSection").style.display = "none"; // Hide metrics initially
            resetProgressBars();
            showLoadingSpinner();
        
            try {
                const selectedFaciliooEntity = $("#entitySelect").val();  // Get selected Facilioo entity
                const selectedCrmEntity = $("#entitySelectCRM").val();    // Get selected CRM entity
        
                // Update Source and Target in the Metrics Section
                document.getElementById("sourceEntity").textContent = selectedFaciliooEntity;
                document.getElementById("targetEntity").textContent = selectedCrmEntity;
        
                // Log start of migration
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Starting migration for Facilioo entity: <b>${selectedFaciliooEntity}</b> to CRM entity: <b>${selectedCrmEntity}</b>...</p>`;
        
                // Fetch matched fields for the selected entities
                const matchedFieldsResponse = await fetch(`/get-matching-fields?selectedFaciliooEntity=${selectedFaciliooEntity}&selectedCrmEntity=${selectedCrmEntity}`, {
                    method: "GET",
                    headers: {"Authorization": `Bearer ${accessToken}`}
                });
        
                if (!matchedFieldsResponse.ok) {
                    throw new Error("Failed to fetch matched fields.");
                }
        
                const matchedFieldsData = await matchedFieldsResponse.json();
                const matchedFields = matchedFieldsData.matched_fields;
        
                if (!matchedFields || matchedFields.length === 0) {
                    throw new Error("No matching fields found for the selected entities.");
                }
        
                // Log matched fields
                logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Retrieved matched fields for migration.</p>`;
                document.getElementById("fetchingProgress").style.width = "100%";
                document.getElementById("fetchingMessage").textContent = "Complete";
        
                // Fetch entity data from staging
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Retrieving data for Facilioo entity: <b>${selectedFaciliooEntity}</b> from staging database...</p>`;
                const entityDataResponse = await fetch(`/get-entity-data?entity_name=${selectedFaciliooEntity}`, {
                    method: "GET",
                    headers: {"Authorization": `Bearer ${accessToken}`}
                });
        
                if (!entityDataResponse.ok) {
                    throw new Error("Failed to fetch entity data from staging.");
                }
        
                const entityData = await entityDataResponse.json();
        
                // Check the structure of entityData to find the number of records
                const totalRecords = entityData.total_records || entityData.data?.length || entityData.length || 0;
        
                logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Retrieved ${totalRecords} records for Facilioo entity: <b>${selectedFaciliooEntity}</b>.</p>`;
        
                // Start migration
                document.getElementById("migrationMessage").textContent = "Starting migration...";
                document.getElementById("migrationProgress").style.width = "0%";
        
                const startTime = Date.now(); // Record start time for velocity calculation
        
                const response = await fetch("/migrate-entity", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        selected_facilioo_entity: selectedFaciliooEntity,
                        selected_crm_entity: selectedCrmEntity
                    }),
                });
        
                if (!response.ok) {
                    throw new Error("Migration failed.");
                }
        
                const data = await response.json();
                const totalMigratedRecords = data.total_records;
                let processedRecords = 0;
        
                // Process migration results
                for (const result of data.results) {
                    processedRecords++;
                    const progress = (processedRecords / totalMigratedRecords) * 100;
                    document.getElementById("migrationProgress").style.width = `${progress}%`;
                    document.getElementById("migrationMessage").textContent = `Migrating record ${result.record_id}...`;
        
                    // Log the current record being processed
                    logsContainer.innerHTML += `
                        <p>
                            <i class="fas fa-sync-alt"></i> Processing record <b>${processedRecords}</b> of <b>${totalMigratedRecords}</b>...
                            <br>
                            <strong>Record ID:</strong> ${result.record_id || "N/A"} <br>
                            <strong>Staging Status:</strong> ${result.staging_status || "N/A"} <br>
                            <strong>CRM Status:</strong> ${result.crm_status || "N/A"} <br>
                            <strong>Action:</strong> ${result.action || "none"} <br>
                            <strong style="color: red;">Error:</strong> ${result.error ? `<span style="color: red;">${result.error}</span>` : "none"} <br>
                            <strong style="color: orange;">Failed Fields:</strong> ${Array.isArray(result.failed_fields) && result.failed_fields.length 
                                ? `<span style="color: orange;">${result.failed_fields.join(", ")}</span>` 
                                : "none"} <br>
                        </p>
                    `;
        
                    await new Promise(resolve => setTimeout(resolve, 100)); // 100ms delay
                }
        
                // Calculate Velocity
                const endTime = Date.now();
                const totalTimeTaken = (endTime - startTime) / 1000; // Convert to seconds
                const velocity = (totalMigratedRecords / totalTimeTaken).toFixed(2);
                document.getElementById("migrationVelocity").textContent = `${velocity} records/sec`;
        
                // Calculate Data Quality
                const dataQuality = ((totalMigratedRecords - data.error_count) / totalMigratedRecords * 100).toFixed(2);
                document.getElementById("dataQuality").textContent = `${dataQuality}%`;
        
                // Update Errors
                document.getElementById("totalErrors").textContent = data.error_count;
                document.getElementById("failedFields").textContent = data.failed_fields?.length || 0;
        
                // Log migration summary
                logsContainer.innerHTML += `
                    <p><i class="fas fa-info-circle"></i> Migration Summary:</p>
                    <p>Total Records: ${totalMigratedRecords}</p>
                    <p>Successfully Migrated: ${data.success_count}</p>
                    <p>Updated: ${data.update_count}</p>
                    <p>Inserted: ${data.insert_count}</p>
                    <p>Failed: ${data.error_count}</p>
                `;
        
                // Update migration summary table
                const summaryTable = document.getElementById("migrationSummaryTable").getElementsByTagName('tbody')[0];
                summaryTable.innerHTML = `
                    <tr>
                        <td class="px-4 py-2">${data.entity_name}</td>
                        <td class="px-4 py-2">${totalMigratedRecords}</td>
                        <td class="px-4 py-2">${data.success_count + data.error_count}</td>
                        <td class="px-4 py-2">${data.insert_count}</td>
                        <td class="px-4 py-2">${data.update_count}</td>
                        <td class="px-4 py-2">${data.error_count}</td>
                    </tr>
                `;


                // Handle Excel download link
                if (data.excel_file_url) {
                    const excelLink = document.getElementById("excelLink");
                    excelLink.href = data.excel_file_url;
                    document.getElementById("excelDownload").style.display = "block";
                }
                // Show the migration summary table and metrics section
                document.getElementById("migrationSummary").style.display = "block";
                document.getElementById("metricsSection").style.display = "block"; // Show metrics section
        
                // Update migration status message
                if (data.error_count === 0) {
                    document.getElementById("migrationMessage").textContent = "Complete";
                } else {
                    document.getElementById("migrationMessage").textContent = "Partial Success";
                }
        
                setTimeout(resetProgressBars, 1000);
            } catch (error) {
                console.error("Error:", error);
                logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred during migration: ${error.message}</p>`;
                document.getElementById("fetchingMessage").textContent = "Fetching: Error";
                document.getElementById("migrationMessage").textContent = "Migration: Error";
            } finally {
                hideLoadingSpinner();
            }
        });
        
        
        function autoScrollLogs() {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.scrollTop = logsContainer.scrollHeight; // Scroll to the bottom
        }


        document.getElementById("authenticateBtn").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            if (!email || !password) {
                alert("Please enter both email and password.");
                return;
            }
            showLoadingSpinner();
            try {
                const response = await fetch("/authenticate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ email, password }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Authentication failed.");
                }

                const data = await response.json();
                accessToken = data.access_token; // Store token globally
                document.getElementById("authForm").style.display = "none";
                document.getElementById("migrationControls").style.display = "block";
                document.getElementById("matchControls").style.display = "block";
                document.getElementById("progressContainer").style.display = "block";
                document.getElementById("logsSection").style.display = "block";
                document.getElementById("entityControls").style.display = "flex";
                await fetchAndPopulateCrmEntities();
                await populateEntityDropdown();
            } catch (error) {
                console.error("Error during authentication:", error);
                alert(`Authentication failed: ${error.message}`);
            } finally {hideLoadingSpinner();}
        });
        async function fetchAndPopulateCrmEntities() {
            try {
                // Fetch CRM entities from the backend
                const response = await fetch("/getfromdb-crm-entities", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    }
                });
        
                // Check if the response is OK
                if (!response.ok) {
                    throw new Error("Failed to fetch CRM entities");
                }
        
                // Parse the response JSON
                const data = await response.json();
        
                // Validate the response structure
                if (!Array.isArray(data)) {
                    throw new Error("Invalid API response format");
                }
        
                // Get the dropdown element
                const entitySelectCRM = document.getElementById("entitySelectCRM");
        
                // Clear existing options
                entitySelectCRM.innerHTML = '<option value="">-- Select a CRM Entity --</option>';
        
                // Populate the dropdown with CRM entities
                data.forEach(entity => {
                    const option = document.createElement("option");
                    option.value = entity.entity_name; // Use entity_name as the value
                    option.textContent = entity.entity_name.replace(/-/g, " "); // Replace hyphens with spaces for display
                    if (!entity.is_active) {
                        option.disabled = true; // Disable the option if the entity is not active
                    }
                    entitySelectCRM.appendChild(option);
                });
                sortSelectOptions("entitySelectCRM"); // Sort after population

                console.log("CRM entities loaded successfully.");
            } catch (error) {
                console.error("Error fetching CRM entities:", error);
                alert("Failed to fetch CRM entities. Please try again.");
            }
        }
    
        function sortSelectOptions(selectId) {
            const select = document.getElementById(selectId);
            const options = Array.from(select.options);
    
            // Exclude the first option (e.g., "-- Select --")
            const sortedOptions = options.slice(1).sort((a, b) => 
                a.text.localeCompare(b.text)
            );
    
            // Clear the select and re-add the default option
            select.innerHTML = "";
            select.appendChild(options[0]);
    
            // Append sorted options
            sortedOptions.forEach(option => select.appendChild(option));
        }
    
        document.addEventListener("DOMContentLoaded", () => {
            if (accessToken) {
                fetchAndPopulateCrmEntities();
                populateEntityDropdown();
            }
        });
        
    async function populateEntityDropdown() {
            try {
                const response = await fetch("/get-facilioo-entities-with-status", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {throw new Error("Failed to fetch entities list");}
                const entities = await response.json();
                const entitySelect = document.getElementById("entitySelect");
                document.getElementById("migrationSummary").style.display = "none";
                entitySelect.innerHTML = '<option value="">-- Select a Facilioo Entity --</option>';
                entities.forEach(entity => {
                    const option = document.createElement("option");
                    option.value = entity.entity_name;
                    option.textContent = entity.entity_name.replace(/-/g, " ");
                    if (!entity.has_data) {option.disabled = true;}
                    entitySelect.appendChild(option);
                });
                sortSelectOptions("entitySelect"); // Sort after population

            } catch (error) {
                console.error("Error fetching entities list:", error);
                alert("Failed to fetch Facilioo entities. Please try again.");
            }
        }
        
        async function fetchEntitiesList() {
            try {
                const response = await fetch("/facilioo-entities");
                if (!response.ok) {throw new Error("Failed to fetch entities list");}
                const entities = await response.json();
                return entities;
            } catch (error) {
                console.error("Error fetching entities list:", error);
                return []; // Return an empty array or handle the error as needed
            }
        }

            document.getElementById("fetchEntityBtnCRM").addEventListener("click", async () => {
                const entitySelect = document.getElementById("entitySelectCRM");
                const selectedEntity = entitySelect.value;
                if (!selectedEntity) {
                    alert("Please select a CRM entity.");
                    return;
                }

                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML = `<p><i class="fas fa-info-circle"></i> Fetching column names for CRM entity: ${selectedEntity}...</p>`;
                autoScrollLogs();
                logsContainer.style.display = "block";

                try {
                    const response = await fetch(`/crm-entity-fields?entity_name=${selectedEntity}`, {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json",
                        },
                    });
                    if (!response.ok) {throw new Error("Failed to fetch CRM entity fields");}
                    const data = await response.json();
                    if (data.success) {
                        logsContainer.innerHTML += `<p><i class="fas fa-list"></i> Entity Columns:</p>`;
                        // Build the formatted list of columns with mandatory fields highlighted
                        let columnListHTML = "<ul>";
                        data.columns.forEach(column => {
                            if (column.mandatory) {
                                columnListHTML += `<li style="color: red;">${column.name} *</li>`; // Red color for required fields
                            } 
                            
                        // Check if the column has upsert = true
                        else if (column.upsert) {
                            columnListHTML += `<li style="color: green;">${column.name} + </li>`; // Green color for upsert fields
                        } 
                            
                            else {columnListHTML += `<li>${column.name}</li>`;}
                        });
                        columnListHTML += "</ul>";
                        logsContainer.innerHTML += columnListHTML;
                        autoScrollLogs();
                    } else {
                        logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch columns for ${selectedEntity}.</p>`;
                        autoScrollLogs();
                    }
                } catch (error) {
                    console.error("Error:", error);
                    logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred while fetching columns for ${selectedEntity}.</p>`;
                    autoScrollLogs();
                }
            });
                
        // Fetch data for the selected entity
        async function fetchEntityData(entityName) {
            try {
                const response = await fetch(`/fetch-and-save-entity?entity_name=${entityName}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {throw new Error("Failed to fetch entity data");}
                const data = await response.json();return data;
            } catch (error) {console.error("Error fetching entity data:", error);throw error;}
        }
            // Event listener for the "Fetch Entity Data" button
            document.getElementById("fetchEntityBtn").addEventListener("click", async () => {
                const entitySelect = document.getElementById("entitySelect");
                const selectedEntity = entitySelect.value;
                const logsContainer = document.getElementById("logsContainer");

                if (!selectedEntity) {
                    alert("Please select an entity.");
                    return;
                }
                showLoadingSpinner();
                logsContainer.innerHTML = "";
                logsContainer.style.display = "block";
                document.getElementById("migrationSummary").style.display = "none";
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Fetching data for entity: ${selectedEntity}...</p>`;
                autoScrollLogs();
                try {
                    // Real-time progress tracking for fetching data
                    document.getElementById("fetchingMessage").textContent = `Fetching ${selectedEntity}...`;
                    document.getElementById("fetchingProgress").style.width = "0%";
                    const eventSource = new EventSource(`/stream-progress?entity_name=${selectedEntity}`);
                    eventSource.onmessage = function (event) {
                        const progress = parseInt(event.data);
                        document.getElementById("fetchingProgress").style.width = `${progress}%`;
                        document.getElementById("fetchingMessage").textContent = `Fetching ${selectedEntity}... ${progress}%`;
                        if (progress === 100) {
                            eventSource.close();
                            logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Data fetched successfully for ${selectedEntity}.</p>`;
                            autoScrollLogs();
                            fetchTotalRows(selectedEntity);
                            setTimeout(() => {
                                document.getElementById("fetchingProgress").style.width = "0%";
                                document.getElementById("fetchingMessage").textContent = "Not Started";
                            }, 1000);
                        }
                    };

                    // Step 1: Fetch & save entity data
                    const fetchResponse = await fetch(`/fetch-and-save-entity?entity_name=${selectedEntity}`, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json",
                        },
                    });

                    if (!fetchResponse.ok) throw new Error("Failed to fetch entity data");

                    const fetchData = await fetchResponse.json();
                    if (fetchData.success) {
                        logsContainer.innerHTML += `<p><i class="fas fa-list"></i> Entity Columns:</p>`;
                        logsContainer.innerHTML += `<pre>${fetchData.columns.join("\n")}</pre>`;
                        autoScrollLogs();
                    } else {
                        throw new Error(`Failed to fetch and save data for ${selectedEntity}`);
                    }

                    // Step 2: Fetch & export entity data (only after fetch-and-save is successful)
                    logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Exporting data for entity: ${selectedEntity}...</p>`;
                    autoScrollLogs();

                    const exportResponse = await fetch("/fetch-and-export/", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ entity_name: selectedEntity }),
                    });

                    if (!exportResponse.ok) throw new Error("Failed to export entity data");

                    const exportData = await exportResponse.json();
                    if (exportData.success) {
                        // Update the Excel download link
                        if (exportData.excel_file_url) {
                            const excelLink = document.getElementById("excelLink");
                            excelLink.href = exportData.excel_file_url;
                        }
                        document.getElementById("excelDownload").style.display = "block";

                        autoScrollLogs();
                    } else {
                        throw new Error(`Failed to export data for ${selectedEntity}`);
                    }

                } catch (error) {
                    logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Error: ${error.message}</p>`;
                    autoScrollLogs();
                } finally {
                    hideLoadingSpinner();
                }
            });



            let clickCount = 0;
            let clickCount2 = 0;
            let clickCount3 = 0;

            const maxClicksForExport = 3;
            const maxClicksForStatusUpdate = 4;
            const maxClicksForCRMList=5;
            const clickableHeading = document.getElementById("clickableHeading");
            const logsContainer = document.getElementById("logsContainer");
            
            // Function to add logs to the logs container
            function addLog(message) {
                const logEntry = document.createElement("p");
                logEntry.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
                logsContainer.appendChild(logEntry);
                autoScrollLogs();
            }
            // Function to update the progress bar
            function updateProgress(percentage) {
                document.getElementById("fetchingProgress").style.width = `${percentage}%`;
            }            
            // Function to fetch and download the Excel file
            async function fetchAndDownloadExcel() {
                try {
                    addLog("Starting the download process...");updateProgress(10);
                    const response = await fetch("/fetch-and-export_all_entities/", {
                        method: "POST",
                        headers: {"Content-Type": "application/json",},
                        body: JSON.stringify({ access_token: accessToken }),
                    });
                    if (!response.ok) {throw new Error("Failed to fetch Excel file.");}
                    const data = await response.json();
                    addLog("Excel file generated successfully.");updateProgress(50);
                    const excelFileUrl = data.excel_file_url;
                    addLog(`Downloading Excel file from: ${excelFileUrl}`);updateProgress(75);
                    const downloadResponse = await fetch(excelFileUrl);
                    if (!downloadResponse.ok) {throw new Error("Failed to download Excel file.");}
                    const blob = await downloadResponse.blob();
                    const downloadLink = document.createElement("a");
                    downloadLink.href = URL.createObjectURL(blob);
                    downloadLink.download = "facilioo_export.xlsx";
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    addLog("Excel file downloaded successfully.");updateProgress(100);
                } catch (error) {addLog(`Error: ${error.message}`);updateProgress(0);}
            }
            
            // Function to update facilioo_entities_with_status table
            async function updateFaciliooEntitiesStatus() {
                try {
                    addLog("Updating facilioo_entities_with_status...");updateProgress(10);
                    const response = await fetch("/facilioo-entities-with-status", {
                        method: "POST",
                        headers: {"Content-Type": "application/json",},
                        body: JSON.stringify({ access_token: accessToken }),
                    });
                    if (!response.ok) {throw new Error("Failed to update entity status.");}
                    addLog("facilioo_entities_with_status updated successfully.");
                    await populateEntityDropdown();updateProgress(100);
                } catch (error) {
                    addLog(`Error: ${error.message}`);updateProgress(0);
                }
            }
            
            async function updateCRMEntitiesList() {
                try {
                    addLog("Updating crm_entities...");
                    updateProgress(10);
            
                    const response = await fetch("/crm-entities-table-save", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${accessToken}`, // Send token in the Authorization header
                        }
                    });
            
                    if (!response.ok) {
                        throw new Error("Failed to update entity status.");
                    }
            
                    const data = await response.json();
                    addLog("crm_entities updated successfully.");
                    
                    // Log the fetched entities
                    if (data.entities && data.entities.length > 0) {
                        addLog(`Fetched ${data.entities.length} entities.`);
                    } else {
                        addLog("No CRM entities found.");
                    }
            
                    await populateEntityDropdown();
                    updateProgress(100);
                } catch (error) {
                    addLog(`Error: ${error.message}`);
                    updateProgress(0);
                }
            }
            

            // Handle heading click
            clickableHeading.addEventListener("click", () => {
                clickCount++;
                clickCount2++;
                clickCount3++;
                addLog(`Heading clicked to download excel file ${clickCount} time(s).`);
                addLog(`Heading clicked for facilioo entities updated ${clickCount2} time(s).`);
                addLog(`Heading clicked for crm entities updated ${clickCount3} time(s).`);

                if (clickCount === maxClicksForExport) {
                    fetchAndDownloadExcel();
                    clickCount = 0;
                } 
                else if (clickCount2 === maxClicksForStatusUpdate) {
                    updateFaciliooEntitiesStatus();
                    clickCount2 = 0;
                }
                else if (clickCount3 === maxClicksForCRMList) {
                    updateCRMEntitiesList();
                    clickCount3 = 0;
                }
            });
            
        async function fetchTotalRows(entityName) {
            try {
                const response = await fetch(`/get-total-rows?entity_name=${entityName}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                    },
                });

                if (!response.ok) {
                    throw new Error("Failed to fetch total rows.");
                }

                const data = await response.json();
                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML += `<p><i class="fas fa-database"></i> Total rows fetched for ${entityName}: ${data.total_records}</p>`;
                autoScrollLogs();
            } catch (error) {
                console.error("Error fetching total rows:", error);
                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch total rows for ${entityName}.</p>`;
                autoScrollLogs();
            }
        }




        async function getCrmContactsUrl() {
            try {
                const response = await fetch('/api/crm-contacts-url');
                if (!response.ok) {throw new Error('Failed to fetch CRM contacts URL');}
                const data = await response.json();
                return data.crmContactsUrl;
            } catch (error) {console.error('Error fetching CRM contacts URL:', error);return null;}
        }
        function resetProgressBars() {
            document.getElementById("fetchingProgress").style.width = "0%";
            document.getElementById("migrationProgress").style.width = "0%";
            document.getElementById("fetchingMessage").textContent = "Fetching : Not Started";
            document.getElementById("migrationMessage").textContent = "Migration: Not Started";
            document.getElementById("fetchingMessage").textContent = "Pending";
            document.getElementById("migrationMessage").textContent = "Pending";
        }
        function showLoadingSpinner() {
            $("#loadingSpinner").show(); 
        }
        
        function hideLoadingSpinner() {
            $("#loadingSpinner").hide();
        }

    </script>
</body>
</html>