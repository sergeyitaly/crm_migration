<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Migration</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>Facillio.de accounts -> CRM contacts</h1>

        <!-- Authentication Form -->
        <div id="authForm">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="Enter your password" required>
            </div>
            <button id="authenticateBtn" class="btn">
                <i class="fas fa-check"></i> Authenticate
            </button>
        </div>

        <!-- Migration Button -->
        <button id="migrateBtn" class="btn" style="display: none;">
            <i class="fas fa-sync-alt"></i> Start Migration
        </button>

        <!-- Progress Bars -->
        <div class="progress-container" style="display: none;">
            <h3>Migration Progress</h3>

            <!-- Fetching Users Progress -->
            <div class="progress-bar">
                <div id="fetchingProgress" class="progress"></div>
            </div>
            <p id="fetchingMessage">Fetching Users: Not Started</p>
            <!-- Migration Progress -->
            <div class="progress-bar">
                <div id="migrationProgress" class="progress"></div>
            </div>
            <p id="migrationMessage">Migration: Not Started</p>
        </div>

        <!-- Status Cards -->
        <div class="status-cards" style="display: none;">
            <div class="card" id="fetchingStatus">
                <h3><i class="fas fa-download"></i> Fetching Status</h3>
                <p id="fetchingStatusMessage">Pending</p>
            </div>
            <div class="card" id="migrationStatus">
                <h3><i class="fas fa-database"></i> Migration Status</h3>
                <p id="migrationStatusMessage">Pending</p>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="logs" style="display: none;">
            <h3><i class="fas fa-clipboard-list"></i> Logs</h3>
            <button id="toggleLogs" class="btn">Show Logs</button>
            <div id="logsContainer" style="display: none;"></div>
        </div>
        <div id="crmLinkContainer" style="display: none;">
            <a id="crmLink" href="#">Go to CRM Contacts</a>
        </div>
        
    </div>

    <script>
        let accessToken = null;
        document.getElementById("toggleLogs").addEventListener("click", function() {
            const logsContainer = document.getElementById("logsContainer");
            if (logsContainer.style.display === "none") {
                logsContainer.style.display = "block";
                this.textContent = "Hide Logs";
            } else {
                logsContainer.style.display = "none";
                this.textContent = "Show Logs";
            }
        });

        document.getElementById("authenticateBtn").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            if (!email || !password) {
                alert("Please enter both email and password.");
                return;
            }

            try {
                const response = await fetch("/authenticate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ email, password }),
                });

                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const text = await response.text();
                    throw new Error(`Unexpected response: ${text}`);
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || "Authentication failed.");
                }

                accessToken = data.access_token;
                document.getElementById("authForm").style.display = "none";
                
                // Show Migrate Button
                document.getElementById("migrateBtn").style.display = "block";

                // Make progress bar & status cards visible
                document.querySelector(".progress-container").style.display = "block";
                document.querySelector(".logs").style.display = "block";
                document.querySelector(".status-cards").style.display = "flex"; // Ensures proper layout

            } catch (error) {
                console.error("Error during authentication:", error);
                alert(`Authentication failed: ${error.message}`);
            }
        });

        async function getCrmContactsUrl() {
            try {
                const response = await fetch('/api/crm-contacts-url');
                if (!response.ok) {
                    throw new Error('Failed to fetch CRM contacts URL');
                }
                const data = await response.json();
                return data.crmContactsUrl;
            } catch (error) {
                console.error('Error fetching CRM contacts URL:', error);
                return null;
            }
        }

        function resetProgressBars() {
            document.getElementById("fetchingProgress").style.width = "0%";
            document.getElementById("migrationProgress").style.width = "0%";
            document.getElementById("fetchingMessage").textContent = "Fetching Users: Not Started";
            document.getElementById("migrationMessage").textContent = "Migration: Not Started";
            document.getElementById("fetchingStatusMessage").textContent = "Pending";
            document.getElementById("migrationStatusMessage").textContent = "Pending";
        }

        document.getElementById("migrateBtn").addEventListener("click", async () => {
            try {
                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML = "";
                resetProgressBars();

                // Fetch and display existing logs
                //await fetchLogs();

                // Fetch and save users from Facil.io to staging DB
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Fetching and saving users to staging...</p>`;
                document.getElementById("fetchingMessage").textContent = "Fetching users...";
                document.getElementById("fetchingProgress").style.width = "50%"; // Update progress bar

                const fetchAndSaveData = await fetchAndSaveUsers(accessToken);

                if (fetchAndSaveData.success) {
                    document.getElementById("fetchingProgress").style.width = "100%"; // Complete progress bar
                    document.getElementById("fetchingStatusMessage").textContent = "Complete";
                    logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Users fetched and saved successfully.</p>`;
                } else {
                    document.getElementById("fetchingStatusMessage").textContent = "Failed";
                    logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch and save users.</p>`;
                    return;
                }

                // Retrieve users from the staging DB
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Retrieving users from staging database...</p>`;
                const users = await getUsersFromStaging();

                logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Retrieved ${users.length} users from staging.</p>`;

                let allUsersMigratedSuccessfully = true; // Track whether all users are migrated successfully

                // Anonymization and Migration for each user
                for (let i = 0; i < users.length; i++) {
                    const user = users[i];
                    const userId = user.id; // Use the correct property (e.g., `id` instead of `user_id`)
                    // Migration
                    document.getElementById("migrationMessage").textContent = `Migrating user ${userId}...`;
                    document.getElementById("migrationProgress").style.width = `${(i / users.length) * 100}%`;
                    logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Migrating user ${userId}...</p>`;

                    const migrationData = await migrateUsers([userId]); // Pass userId as a list

                    if (migrationData.results && migrationData.results.length > 0) {
                        const result = migrationData.results[0]; // Get the result for the current user
                        if (result.staging_status === "Success" && result.crm_status === "Success") {
                            document.getElementById("migrationProgress").style.width = `${((i + 1) / users.length) * 100}%`;
                            logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Migration successful for user ${userId}.</p>`;
                        } else {
                            allUsersMigratedSuccessfully = false; // Mark as failed
                            logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Migration failed for user ${userId}: ${result.error || "Unknown error"}</p>`;
                            continue; // Skip to next user
                        }
                    } else {
                        allUsersMigratedSuccessfully = false; // Mark as failed
                        logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Migration failed for user ${userId}: No result returned.</p>`;
                        continue; // Skip to next user
                    }
                }

                // Update Migration Status
                if (allUsersMigratedSuccessfully) {
                    document.getElementById("migrationStatusMessage").textContent = "Complete";

                    // Fetch the CRM contacts URL from the backend
                    const crmContactsUrl = await getCrmContactsUrl();

                    if (crmContactsUrl) {
                        // Update the link and show the container
                        document.getElementById("crmLink").href = crmContactsUrl;
                        document.getElementById("crmLinkContainer").style.display = "flex";
                    } else {
                        console.error('CRM contacts URL is not available');
                    }
                } else {
                    document.getElementById("migrationStatusMessage").textContent = "Failed";
                }

                // Reset progress bars after 1 second
                setTimeout(resetProgressBars, 1000);

                // Fetch and display updated logs after migration
                //await fetchLogs();
            } catch (error) {
                console.error("Error:", error);
                logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred during migration.</p>`;
                document.getElementById("fetchingMessage").textContent = "Fetching: Error";
                document.getElementById("anonymizationMessage").textContent = "Anonymization: Error";
                document.getElementById("migrationMessage").textContent = "Migration: Error";
            }
        });

        // Helper functions (fetchLogs, anonymizeUser, migrateUser, fetchAndSaveUsers, getUsersFromStaging)...
        async function fetchLogs() {
            try {
                const response = await fetch('/migration-logs');
                if (!response.ok) {
                    throw new Error('Failed to fetch logs');
                }
                const data = await response.json();
                const logsContainer = document.getElementById('logsContainer');
                logsContainer.innerHTML = '';
                data.logs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.classList.add('log-entry');
                    logElement.innerHTML = `
                        <strong>User ID:</strong> ${log.user_id} <br>
                        <strong>Staging Status:</strong> ${log.staging_status} <br>
                        <strong>CRM Status:</strong> ${log.crm_status} <br>
                        <strong>Time:</strong> ${log.created_at} <br>
                    `;
                    logsContainer.appendChild(logElement);
                });
            } catch (error) {
                console.error('Error fetching logs:', error);
                const logsContainer = document.getElementById('logsContainer');
                logsContainer.innerHTML = `<p><i class="fas fa-times-circle"></i> Error fetching logs: ${error.message}</p>`;
            }
        }

        async function migrateUsers(user_ids) {
            try {
                const response = await fetch("/migrate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        user_ids: user_ids, // Send a list of user_ids
                    }),
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    console.error("Migration failed:", errorDetails);
                    throw new Error(`Migration failed: ${response.status}`);
                }

                const result = await response.json();
                return result; // Return the result for further processing
            } catch (error) {
                console.error("Failed to migrate users:", error);
                throw error; // Re-throw the error to handle it in the caller
            }
        }

        async function fetchAndSaveUsers(accessToken) {
            try {
                console.log("Access Token:", accessToken); // Debugging
                const response = await fetch("/fetch-and-save-users", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`,
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to fetch and save users');
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error during fetch and save users:", error);
                throw new Error(error.message || 'Error fetching and saving users');
            }
        }

        async function getUsersFromStaging() {
            try {
                const response = await fetch("/users");
                if (!response.ok) {
                    throw new Error('Failed to fetch users from staging');
                }
                const users = await response.json();
                return users;
            } catch (error) {
                console.error("Error fetching users from staging:", error);
                throw new Error('Error fetching users from staging');
            }
        }
    </script>
</body>
</html>